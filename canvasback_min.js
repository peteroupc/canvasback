(function(p,f){"function"===typeof define&&define.amd?define(["exports"],f):"object"===typeof exports?f(exports):f(p)})(this,function(p){if(!p.Promise){var f=function(a){this._state=0;this._timeout=this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];a&&this._invokeResolver(a)};f.resolve=function(a){return new this(function(b,c){b(a)})};f.reject=function(a){return new this(function(b,c){c(a)})};f.all=f.when=function(a){return new this(function(b,c){var d=0,e=[];a.forEach(function(a,
f){d++;a.then(function(a){e[f]=a;d--;d||b(e)},function(a){d=1/0;c(a)})})})};f.race=function(a){return new this(function(b,c){a.forEach(function(a){a.then(b,c)})})};f.prototype.then=function(a,b){this._cb.fulfilled.push(a);this._cb.rejected.push(b);var c=new f;this._thenPromises.push(c);0<this._state&&this._schedule();return c};f.prototype.fulfill=function(a){if(0!=this._state)return this;this._state=1;this._value=a;this._thenPromises.length&&this._schedule();return this};f.prototype.reject=function(a){if(0!=
this._state)return this;this._state=2;this._value=a;this._thenPromises.length&&this._schedule();return this};f.prototype.resolve=function(a){if(a==this)this.reject(new TypeError("Promise resolved by its own instance"));else if(a instanceof this.constructor)a.chain(this);else if(null===a||"object"!=typeof a&&"function"!=typeof a)this.fulfill(a);else{try{var b=a.then}catch(c){this.reject(c);return}if("function"==typeof b){var d=!1,e=function(a){d||(d=!0,this.resolve(a))},g=function(a){d||(d=!0,this.reject(a))};
try{b.call(a,e.bind(this),g.bind(this))}catch(f){d||this.reject(f)}}else this.fulfill(a)}};f.prototype.chain=function(a){return this.then(function(b){a.resolve(b)},function(b){a.reject(b)})};f.prototype["catch"]=function(a){return this.then(null,a)};f.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};f.prototype._processQueue=function(){for(this._timeout=null;this._thenPromises.length;){var a=this._cb.fulfilled.shift(),b=this._cb.rejected.shift();
this._executeCallback(1==this._state?a:b)}};f.prototype._executeCallback=function(a){var b=this._thenPromises.shift();if("function"!=typeof a)1==this._state?b.fulfill(this._value):b.reject(this._value);else try{var c=a(this._value);b.resolve(c)}catch(d){b.reject(d)}};f.prototype._invokeResolver=function(a){try{a(this.resolve.bind(this),this.reject.bind(this))}catch(b){this.reject(b)}};p.Promise=f}});
(function(p,f){"function"==typeof define&&define.amd?define(["exports"],f):"object"==typeof exports?f(exports):f(p)})(this,function(p){if(!p.GLMath){var f={vec3cross:function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},vec3dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec3addInPlace:function(a,b){var c=b[1],d=b[2];a[0]+=b[0];a[1]+=c;a[2]+=d;return a},vec3subInPlace:function(a,b){var c=b[1],d=b[2];a[0]-=b[0];a[1]-=c;a[2]-=d;return a},vec3mulInPlace:function(a,
b){var c=b[1],d=b[2];a[0]*=b[0];a[1]*=c;a[2]*=d;return a},vec3scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},vec4dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},vec4scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},vec3normInPlace:function(a){var b=a[0],c=a[1],d=a[2];len=Math.sqrt(b*b+c*c+d*d);0!=len&&(len=1/len,a[0]*=len,a[1]*=len,a[2]*=len);return a},vec4normInPlace:function(a){var b=a[0],c=a[1],d=a[2],e=a[3];len=Math.sqrt(b*b+c*c+d*d+e*e);0!=len&&
(len=1/len,a[0]*=len,a[1]*=len,a[2]*=len,a[3]*=len);return a},vec3norm:function(a){return f.vec3normInPlace([a[0],a[1],a[2]])},vec4norm:function(a){return f.vec4normInPlace([a[0],a[1],a[2],a[3]])},vec3length:function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)},vec4length:function(a){var b=a[0],c=a[1],d=a[2];a=a[3];return Math.sqrt(b*b+c*c+d*d+a*a)},mat3identity:function(){return[1,0,0,0,1,0,0,0,1]},mat4identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},quatIdentity:function(){return[0,
0,0,1]},mat4copy:function(a){return a.slice(0,16)},vec4copy:function(a){return a.slice(0,4)},mat4invert:function(a){var b=a[0]*a[10],c=a[0]*a[11],d=a[0]*a[5],e=a[0]*a[6],g=a[0]*a[7],m=a[0]*a[9],h=a[10]*a[12],k=a[10]*a[13],n=a[10]*a[15],l=a[11]*a[12],t=a[11]*a[13],r=a[11]*a[14],u=a[1]*a[4],v=a[1]*a[6],w=a[1]*a[7],E=a[1]*a[8],x=a[2]*a[4],y=a[2]*a[5],z=a[2]*a[7],F=a[2]*a[8],p=a[2]*a[9],q=a[3]*a[4],G=a[3]*a[5],H=a[3]*a[6],I=a[3]*a[8],J=a[3]*a[9],K=a[4]*a[9],L=a[5]*a[8],M=a[6]*a[8],N=a[6]*a[9],O=a[7]*
a[8],P=a[7]*a[9],A=u-d,B=v-y,C=w-G,D=x-e,d=d-u,v=y-v,y=z-H,u=q-g,w=G-w,z=H-z,e=e-x,x=g-q,g=a[9]*a[12]*z+h*C+l*v+a[8]*a[13]*y+k*u+t*e+a[8]*a[14]*w+a[9]*a[14]*x+r*A+a[8]*a[15]*B+a[9]*a[15]*D+n*d;if(0==g)return f.mat4identity();g=1/g;q=[];q[0]=a[6]*t-a[7]*k+P*a[14]-a[5]*r-N*a[15]+a[5]*n;q[1]=a[3]*k-a[2]*t-J*a[14]+a[1]*r+p*a[15]-a[1]*n;q[2]=a[13]*y+a[14]*w+a[15]*B;q[3]=a[9]*z+a[10]*C+a[11]*v;q[4]=a[7]*h-a[6]*l-O*a[14]+a[4]*r+M*a[15]-a[4]*n;q[5]=a[2]*l-a[3]*h+a[14]*(I-c)+a[15]*(b-F);q[6]=a[12]*z+a[14]*
x+a[15]*D;q[7]=a[8]*y+a[10]*u+a[11]*e;q[8]=a[5]*l-P*a[12]+O*a[13]-a[4]*t+a[15]*(K-L);q[9]=J*a[12]-a[1]*l+a[13]*(c-I)+a[15]*(E-m);q[10]=a[12]*C+a[13]*u+a[15]*d;q[11]=a[8]*w+a[9]*x+a[11]*A;q[12]=N*a[12]-a[5]*h-M*a[13]+a[4]*k+a[14]*(L-K);q[13]=a[1]*h-p*a[12]+a[13]*(F-b)+a[14]*(m-E);q[14]=a[12]*v+a[13]*e+a[14]*A;q[15]=a[8]*B+a[9]*D+a[10]*d;for(a=0;16>a;a++)q[a]*=g;return q},quatConjugate:function(a){return[-a[0],-a[1],-a[2],a[3]]},quatInverse:function(a){return f.quatNormInPlace(f.quatConjugate(a))},
quatIsIdentity:function(a){return 0==a[0]&&0==a[1]&&0==a[2]&&1==a[3]},quatToMat4:function(a){var b,c,d,e,g,f,h,k,n;b=2*a[0];c=2*a[1];d=2*a[2];e=b*a[0];g=b*a[1];f=b*a[2];h=c*a[1];k=d*a[1];n=d*a[2];b*=a[3];c*=a[3];a=d*a[3];return[1-(h+n),g+a,f-c,0,g-a,1-(e+n),k+b,0,f+c,k-b,1-(e+h),0,0,0,0,1]},quatToAxisAngle:function(a){var b=a[3],c=1-b*b;return 0<c?(c=1/Math.sqrt(c),[a[0]*c,a[1]*c,a[2]*c,Math.acos(b)*f.Num360DividedByPi]):[0,1,0,0]},quatFromVectors:function(a,b){var c=f.vec3cross(a,b),d=Math.sqrt(f.vec3dot(a,
a))*Math.sqrt(f.vec3dot(b,b));0==d&&(d=1);c[3]=d+f.vec3dot(a,b);return f.quatNormInPlace(c)},quatFromAxisAngle:function(a,b,c,d){var e;"undefined"!=typeof c&&"undefined"!=typeof d?(e=b,b=d,d=a*f.PiDividedBy360):"undefined"==typeof b?(e=a[0],c=a[1],b=a[2],d=a[3],d*=f.PiDividedBy360):(e=b[0],c=b[1],b=b[2],d=a*f.PiDividedBy360);a=Math.cos(d);d=Math.sin(d);e=[e,c,b,a];e[0]*=d;e[1]*=d;e[2]*=d;return e},quatFromEuler:function(a,b,c,d){var e,g;null==d&&(d=f.RollPitchYaw);if(0>d||6<=d)throw Error("invalid mode");
a.constructor==Array?(c=a[2]*f.PiDividedBy360,e=a[0]*f.PiDividedBy360,g=a[1]*f.PiDividedBy360):(c*=f.PiDividedBy360,e=a*f.PiDividedBy360,g=b*f.PiDividedBy360);a=Math.sin(e);e=Math.cos(e);b=Math.sin(g);g=Math.cos(g);var m=Math.sin(c);c=Math.cos(c);if(d==f.PitchYawRoll||d==f.PitchRollYaw){var h=[m*b,c*b,m*g,c*g];d==f.PitchYawRoll&&(h[0]=-h[0]);d=[h[3]*a+h[0]*e,h[1]*e+h[2]*a,h[2]*e-h[1]*a,h[3]*e-h[0]*a]}else d==f.YawPitchRoll||d==f.YawRollPitch?(h=[c*a,m*a,m*e,c*e],d==f.YawRollPitch&&(h[1]=-h[1]),d=
[h[0]*g-h[2]*b,h[3]*b+h[1]*g,h[2]*g+h[0]*b,h[3]*g-h[1]*b]):(h=[g*a,b*e,b*a,g*e],d==f.RollPitchYaw&&(h[2]=-h[2]),d=[h[0]*c+h[1]*m,h[1]*c-h[0]*m,h[3]*m+h[2]*c,h[3]*c-h[2]*m]);return d},quatToEuler:function(a,b){var c=a[3],d,e,g,m=1;null==b&&(b=f.RollPitchYaw);if(0>b||6<=b)throw Error("invalid mode");b==f.RollPitchYaw?(d=a[1],e=a[0],g=a[2],m=-1):b==f.PitchYawRoll?(d=a[2],e=a[1],g=a[0],m=-1):b==f.PitchRollYaw?(d=a[1],e=a[2],g=a[0]):b==f.YawPitchRoll?(d=a[2],e=a[0],g=a[1]):b==f.YawRollPitch?(d=a[0],e=
a[2],g=a[1],m=-1):(d=a[0],e=a[1],g=a[2]);var h=e*e,k=g*g,n=Math.atan2(2*(c*d-m*e*g),1-2*(d*d+h)),l=2*(c*e+m*d*g);1<l&&(l=1);-1>l&&(l=-1);l=Math.asin(l);e=Math.atan2(2*(c*g-m*d*e),1-2*(h+k));n*=f.Num180DividedByPi;l*=f.Num180DividedByPi;e*=f.Num180DividedByPi;if(1E-6>Math.abs(l-90)||1E-6>Math.abs(l+90))e=0,n=Math.atan2(d,c)*f.Num180DividedByPi,isNaN(n)&&(n=0);c=[];b==f.RollPitchYaw?(c[0]=l,c[1]=n,c[2]=e):b==f.PitchYawRoll?(c[0]=e,c[1]=l,c[2]=n):b==f.PitchRollYaw?(c[0]=e,c[1]=n,c[2]=l):b==f.YawPitchRoll?
(c[0]=l,c[1]=e,c[2]=n):b==f.YawRollPitch?(c[0]=n,c[1]=e,c[2]=l):(c[0]=n,c[1]=l,c[2]=e);return c},quatSlerp:function(a,b,c){var d=f.quatDot(a,b),e=b;0>d&&(e=[-b[0],-b[1],-b[2],-b[3]],d=f.quatDot(a,e));b=0;if(-1<d)if(1>d){if(b=Math.acos(d),0==b)return e.slice(0,4)}else return e.slice(0,4);else b=Math.PI;var g=1/Math.sin(b),d=Math.sin((1-c)*b)*g;c=Math.sin(c*b)*g;return[a[0]*d+e[0]*c,a[1]*d+e[1]*c,a[2]*d+e[2]*c,a[3]*d+e[3]*c]},quatRotate:function(a,b,c,d,e){return f.quatMultiply(a,f.quatFromAxisAngle(b,
c,d,e))},quatTransform:function(a,b){var c=f.vec3cross(a,b);c[0]+=b[0]*a[3];c[1]+=b[1]*a[3];c[2]+=b[2]*a[3];var d=f.vec3cross(c,a),e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2];return[a[0]*e+c[0]*a[3]-d[0],a[1]*e+c[1]*a[3]-d[1],a[2]*e+c[2]*a[3]-d[2],1]},quatFromMat4:function(a){var b=[],c=a[1],d=a[2],e=a[4],g=a[6],f=a[8],h=a[9],k=a[0]+a[5]+a[10];0<=k?(a=.5*Math.sqrt(k+1),k=.25/a,b[0]=(g-h)*k,b[1]=(f-d)*k,b[2]=(c-e)*k,b[3]=a):a[0]>a[5]&&a[0]>a[10]?(a=.5*Math.sqrt(1+a[0]-a[5]-a[10]),k=.25/a,b[0]=a,b[1]=(e+c)*k,b[2]=
(d+f)*k,b[3]=(g-h)*k):a[5]>a[10]?(a=.5*Math.sqrt(1+a[5]-a[0]-a[10]),k=.25/a,b[0]=(e+c)*k,b[1]=a,b[2]=(h+g)*k,b[3]=(f-d)*k):(a=.5*Math.sqrt(1+a[10]-a[0]-a[5]),k=.25/a,b[0]=(f+d)*k,b[1]=(h+g)*k,b[2]=a,b[3]=(c-e)*k);return b},mat4toMat3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},mat4inverseTranspose:function(a){a=f.mat4invert(a);var b;b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];
a[14]=b;return a},mat4inverseTranspose3:function(a){a=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];var b=a[0]*a[4]*a[8]+a[3]*a[7]*a[2]+a[6]*a[1]*a[5]-a[6]*a[4]*a[2]-a[3]*a[1]*a[8]-a[0]*a[7]*a[5];if(0==b)return[1,0,0,0,1,0,0,0,1];b=1/b;return[(-a[5]*a[7]+a[4]*a[8])*b,(a[5]*a[6]-a[3]*a[8])*b,(-a[4]*a[6]+a[3]*a[7])*b,(a[2]*a[7]-a[1]*a[8])*b,(-a[2]*a[6]+a[0]*a[8])*b,(a[1]*a[6]-a[0]*a[7])*b,(-a[2]*a[4]+a[1]*a[5])*b,(a[2]*a[3]-a[0]*a[5])*b,(-a[1]*a[3]+a[0]*a[4])*b]},mat4scale:function(a,b,c,d){var e;
"undefined"!=typeof c&&"undefined"!=typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0]*e,a[1]*e,a[2]*e,a[3]*e,a[4]*c,a[5]*c,a[6]*c,a[7]*c,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12],a[13],a[14],a[15]]},mat4scaled:function(a,b,c){return"undefined"!=typeof b&&"undefined"!=typeof c?[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]:[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]},mat4transform:function(a,b,c,d,e){var g;"undefined"!=typeof c&&"undefined"!=typeof d&&"undefined"!=typeof e?(g=b,b=e):(g=b[0],c=b[1],d=b[2],b=b[3]);
return[g*a[0]+c*a[4]+d*a[8]+b*a[12],g*a[1]+c*a[5]+d*a[9]+b*a[13],g*a[2]+c*a[6]+d*a[10]+b*a[14],g*a[3]+c*a[7]+d*a[11]+b*a[15]]},mat3transform:function(a,b,c,d){var e;"undefined"!=typeof c&&"undefined"!=typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[e*a[0]+c*a[3]+b*a[6],e*a[1]+c*a[4]+b*a[7],e*a[2]+c*a[5]+b*a[8]]},mat4translated:function(a,b,c){var d;"undefined"!=typeof b&&"undefined"!=typeof c?(d=a,a=c):(d=a[0],b=a[1],a=a[2]);return[1,0,0,0,0,1,0,0,0,0,1,0,d,b,a,1]},mat4translate:function(a,b,c,d){var e;
"undefined"!=typeof c&&"undefined"!=typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[0]*e+a[4]*c+a[8]*b+a[12],a[1]*e+a[5]*c+a[9]*b+a[13],a[2]*e+a[6]*c+a[10]*b+a[14],a[3]*e+a[7]*c+a[11]*b+a[15]]},mat4perspective:function(a,b,c,d){a=1/Math.tan(a*f.PiDividedBy360);var e;e=1/(c-d);return[a/b,0,0,0,0,a,0,0,0,0,e*(c+d),-1,0,0,e*c*d*2,0]},mat4lookat:function(a,b,c){c||(c=[0,1,0]);b||(b=[0,0,0]);b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];var d=f.vec3length(b);
if(1E-6>d)return f.mat4identity();d=1/d;b[0]*=d;b[1]*=d;b[2]*=d;c=f.vec3norm(c);c=f.vec3cross(b,c);f.vec3normInPlace(c);d=f.vec3cross(c,b);f.vec3normInPlace(d);b[0]=-b[0];b[1]=-b[1];b[2]=-b[2];return[c[0],d[0],b[0],0,c[1],d[1],b[1],0,c[2],d[2],b[2],0,-f.vec3dot(a,c),-f.vec3dot(a,d),-f.vec3dot(a,b),1]},mat4ortho:function(a,b,c,d,e,g){var f=1/(b-a),h=1/(d-c),k=1/(g-e);return[2*f,0,0,0,0,2*h,0,0,0,0,-2*k,0,-(a+b)*f,-(d+c)*h,-(e+g)*k,1]},mat4ortho2d:function(a,b,c,d){return f.mat4ortho2d(a,b,c,d,-1,1)},
mat4frustum:function(a,b,c,d,e,g){var f=2*e,h=1/(b-a),k=1/(d-c),n=1/(g-e);return[f*h,0,0,0,0,f*k,0,0,(a+b)*h,(d+c)*k,-(g+e)*n,-1,0,0,-(f*g)*n,0]},mat4scaleInPlace:function(a,b,c,d){var e;"undefined"!=typeof c&&"undefined"!=typeof d?(e=b,b=d):(e=b[0],c=b[1],b=b[2]);a[0]*=e;a[1]*=e;a[2]*=e;a[3]*=e;a[4]*=c;a[5]*=c;a[6]*=c;a[7]*=c;a[8]*=b;a[9]*=b;a[10]*=b;a[11]*=b;return a},mat4multiply:function(a,b){for(var c=[],d=0;16>d;d+=4)for(var e=0;4>e;e++)c[d+e]=b[d]*a[e]+b[d+1]*a[e+4]+b[d+2]*a[e+8]+b[d+3]*a[e+
12];return c},quatMultiply:function(a,b){return[a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],a[3]*b[1]+a[1]*b[3]+a[2]*b[0]-a[0]*b[2],a[3]*b[2]+a[2]*b[3]+a[0]*b[1]-a[1]*b[0],a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2]]},mat4rotate:function(a,b,c,d,e){var g,m;"undefined"!=typeof d&&"undefined"!=typeof e?(g=c,m=d,c=e,e=b*f.PiDividedBy180):"undefined"==typeof c?(g=b[0],m=b[1],c=b[2],e=b[3],e*=f.PiDividedBy180):(g=c[0],m=c[1],c=c[2],e=b*f.PiDividedBy180);b=Math.cos(e);var h=Math.sin(e);if(1==g&&0==m&&0==c)return[a[0],
a[1],a[2],a[3],b*a[4]+a[8]*h,b*a[5]+a[9]*h,b*a[6]+a[10]*h,b*a[7]+a[11]*h,b*a[8]-h*a[4],b*a[9]-h*a[5],b*a[10]-h*a[6],b*a[11]-h*a[7],a[12],a[13],a[14],a[15]];if(0==g&&1==m&&0==c)return[b*a[0]-h*a[8],b*a[1]-h*a[9],b*a[2]-h*a[10],b*a[3]-h*a[11],a[4],a[5],a[6],a[7],b*a[8]+a[0]*h,b*a[9]+a[1]*h,b*a[10]+a[2]*h,b*a[11]+a[3]*h,a[12],a[13],a[14],a[15]];if(0==g&&0==m&&1==c)return[b*a[0]+a[4]*h,b*a[1]+a[5]*h,b*a[2]+a[6]*h,b*a[3]+a[7]*h,b*a[4]-h*a[0],b*a[5]-h*a[1],b*a[6]-h*a[2],b*a[7]-h*a[3],a[8],a[9],a[10],a[11],
a[12],a[13],a[14],a[15]];if(0==g&&0==m&&0==c)return a.slice(0,16);e=1/Math.sqrt(g*g+m*m+c*c);g*=e;m*=e;c*=e;var k=m*m;d=1-b;var n=g*m,l=m*c;e=g*h;m*=h;var t=c*h,h=d*l,r=d*n,u=d*g*c;g=b+d*g*g;n=r+t;l=u-m;k=b+d*k;t=r-t;r=h+e;c=b+d*c*c;b=u+m;e=h-e;return[a[0]*g+a[4]*n+a[8]*l,a[1]*g+a[5]*n+a[9]*l,a[10]*l+a[2]*g+a[6]*n,a[11]*l+a[3]*g+a[7]*n,a[0]*t+a[4]*k+a[8]*r,a[1]*t+a[5]*k+a[9]*r,a[10]*r+a[2]*t+a[6]*k,a[11]*r+a[3]*t+a[7]*k,a[0]*b+a[4]*e+a[8]*c,a[1]*b+a[5]*e+a[9]*c,a[10]*c+a[2]*b+a[6]*e,a[11]*c+a[3]*
b+a[7]*e,a[12],a[13],a[14],a[15]]},mat4rotated:function(a,b,c,d){var e;"undefined"!=typeof c&&"undefined"!=typeof d?(e=b,b=d,d=a*f.PiDividedBy180):"undefined"==typeof b?(e=a[0],c=a[1],b=a[2],d=a[3],d*=f.PiDividedBy180):(e=b[0],c=b[1],b=b[2],d=a*f.PiDividedBy180);a=Math.cos(d);var g=Math.sin(d);if(1==e&&0==c&&0==b)return[1,0,0,0,0,a,g,0,0,-g,a,0,0,0,0,1];if(0==e&&1==c&&0==b)return[a,0,-g,0,0,1,0,0,g,0,a,0,0,0,0,1];if(0==e&&0==c&&1==b)return[a,g,0,0,-g,a,0,0,0,0,1,0,0,0,0,1];if(0==e&&0==c&&0==b)return[1,
0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];d=1/Math.sqrt(e*e+c*c+b*b);e*=d;c*=d;b*=d;d=e*e;var m=c*c,h=b*b,k=e*b,n=c*b,l=e*g,t=c*g,g=b*g,r=1-a;e=r*e*c;c=r*k;b=r*n;return[a+r*d,e+g,c-t,0,e-g,a+r*m,b+l,0,c+t,b-l,a+r*h,0,0,0,0,1]}};f.quatDot=f.vec4dot;f.quatNormInPlace=f.vec4normInPlace;f.quatNorm=f.vec4norm;f.quatLength=f.vec4length;f.quatScaleInPlace=f.vec4scaleInPlace;f.quatCopy=f.vec4copy;f.PiDividedBy180=.017453292519943295;f.PiDividedBy360=.008726646259971648;f.Num360DividedByPi=114.59155902616465;f.Num180DividedByPi=
57.29577951308232;f.PitchYawRoll=0;f.PitchRollYaw=1;f.YawPitchRoll=2;f.YawRollPitch=3;f.RollPitchYaw=4;f.RollYawPitch=5;p.GLMath=f}});
(function(p,f){"function"===typeof define&&define.amd?define(["exports"],f):"object"===typeof exports?f(exports):f(p)})(this,function(p){function f(a,b,c,d){this.ambient=b||[0,0,0,1];this.position=a?[a[0],a[1],a[2],1]:[0,0,1,0];this.diffuse=c||[1,1,1];this.specular=d||[1,1,1]}function a(){this.lights=[new f];this.sceneAmbient=[.2,.2,.2]}function b(a,b,c,d,e){null!=a&&(a=k.toGLColor(a));null!=b&&(b=k.toGLColor(b));null!=c&&(c=k.toGLColor(c));null!=e&&(e=k.toGLColor(e));this.shininess=null==d?0:Math.min(Math.max(0,
d),128);this.ambient=a||[.2,.2,.2];this.diffuse=b||[.8,.8,.8];this.specular=c||[0,0,0];this.emission=e||[0,0,0]}function c(a,b){this.subMeshes=[];this.context=k._toContext(b);for(var c=0;c<a.subMeshes.length;c++){var e=a.subMeshes[c];0!=e.indices.length&&this.subMeshes.push(new d(e,this.context))}}function d(a,b){var c=b.createBuffer(),d=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,c);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,d);b.bufferData(b.ARRAY_BUFFER,new Float32Array(a.vertices),b.STATIC_DRAW);var e=
b.UNSIGNED_SHORT;65536<=a.vertices.length||65536<=a.indices.length?(e=b.UNSIGNED_INT,b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint32Array(a.indices),b.STATIC_DRAW)):256>=a.vertices.length&&256>=a.indices.length?(e=b.UNSIGNED_BYTE,b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint8Array(a.indices),b.STATIC_DRAW)):b.bufferData(b.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.indices),b.STATIC_DRAW);this.verts=c;this.faces=d;this.facesLength=a.indices.length;this.type=e;this.format=a.attributeBits;this.context=b}function e(a,
b,c){if(0>b||0>c)throw Error("width or height negative");this.context=a;this.buffer=a.createFramebuffer();this.colorTexture=a.createTexture();this.width=Math.ceil(b);this.height=Math.ceil(c);this.context.pixelStorei(this.context.UNPACK_FLIP_Y_WEBGL,1);this.context.bindTexture(this.context.TEXTURE_2D,this.colorTexture);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,
this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE);this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.width,this.height,0,this.context.RGBA,this.context.UNSIGNED_BYTE,null);this.depthbuffer=this.context.createRenderbuffer();b=this.context.getParameter(a.FRAMEBUFFER_BINDING);this.context.bindFramebuffer(a.FRAMEBUFFER,
this.buffer);this.context.bindRenderbuffer(a.RENDERBUFFER,this.depthbuffer);this.context.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height);this.context.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.colorTexture,0);this.context.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,this.depthbuffer);this.context.bindFramebuffer(a.FRAMEBUFFER,b)}function g(b){var c=b;"function"==typeof b.getContext&&(c=HTMLCanvasElement&&c.constructor==
HTMLCanvasElement?k.get3DContext(b):k._toContext(c));this.context=c;this.specularEnabled=this.lightingEnabled=!0;this.program=new ShaderProgram(c,this._getDefines()+ShaderProgram.getDefaultVertex(),this._getDefines()+ShaderProgram.getDefaultFragment());this.shapes=[];this.clearColor=[0,0,0,1];this.fboFilter=null;this.textureCache={};this._projectionMatrix=GLMath.mat4identity();this._viewMatrix=GLMath.mat4identity();this._invView=null;this.lightSource=new a;this.width=Math.ceil(1*this.context.canvas.width);
this.height=Math.ceil(1*this.context.canvas.height);this.context.viewport(0,0,this.width,this.height);this.context.enable(c.BLEND);this.context.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);this.context.enable(this.context.DEPTH_TEST);this.context.depthFunc(this.context.LEQUAL);this.context.clearDepth(999999);this._setClearColor();this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT);this.useProgram(this.program)}function m(){this.shapes=[]}function h(a){if(null==a)throw Error("mesh is null");
this.bufferedMesh=a;this.material=new b;this.scale=[1,1,1];this.position=[0,0,0];this.rotation=GLMath.quatIdentity();this._matrixDirty=!1;this.matrix=GLMath.mat4identity()}if(!p.GLUtil){var k={renderLoop:function(a){a();var b=function(){window.requestAnimationFrame(b);a()};window.requestAnimationFrame(b)},createCanvas:function(a,b,c){var d=document.createElement("canvas");if(null==a)d.width=Math.ceil(window.innerWidth)+"";else{if(0>a)throw Error("width negative");d.width=Math.ceil(a)+""}if(null==
b)d.height=Math.ceil(window.innerHeight)+"";else{if(0>b)throw Error("height negative");d.height=Math.ceil(b)+""}c&&c.appendChild(d);return d},get3DOr2DContext:function(a){if(!a||!a.getContext)return null;var b=null,c={antialias:!0};try{b=a.getContext("webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("experimental-webgl",c)}catch(e){b=null}if(!b)try{b=a.getContext("moz-webgl",c)}catch(f){b=null}if(!b)try{b=a.getContext("webkit-3d",c)}catch(g){b=null}if(!b)try{b=a.getContext("2d",c)}catch(h){b=null}k.is3DContext(b)&&
b.getExtension("OES_element_index_uint");return b},get3DContext:function(a,b){var c=k.get3DOr2DContext(a),d=null;!c&&window.WebGLShader?d="Failed to initialize graphics support required by this page.":window.WebGLShader&&!k.is3DContext(c)?d="This page requires WebGL, but it failed to start. Your computer might not support WebGL.":c&&k.is3DContext(c)||(d="This page requires a WebGL-supporting browser.");return d?((b||window.alert)(d),null):c},is3DContext:function(a){return a&&"compileShader"in a},
getPromiseResults:function(a,b,c){return a&&0!=a.length?new Promise(function(d,e){for(var f={successes:[],failures:[]},g=a.length,h=0,k=0;k<g;k++)a[k].then(function(a){f.successes.push(a);b&&b(a);h++;h==g&&d(f)},function(a){f.failures.push(a);c&&c(a);h++;h==g&&d(f)})}):Promise.resolve({successes:[],failures:[]})},loadFileFromUrl:function(a,b){var c=b||"text";return new Promise(function(b,d){var e=new XMLHttpRequest;e.onreadystatechange=function(e){e=e.target;if(4==e.readyState)if(200<=e.status&&300>
e.status){var f=e.response;f||(f="xml"==c?e.responseXML:"json"==c?e.responseJSON||JSON.parse(e.responseText):e.responseText);b({url:a,data:f+""})}else d({url:a})};e.onerror=function(b){d({url:a})};e.open("get",a,!0);e.responseType=c;e.send()})}};window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.requestAnimationFrame||(window.requestAnimationFrame=function(a){window.setTimeout(a,17)}));
(function(a){var b=function(a){var b=1*a[0],c=1*a[1],d=1*a[2],c=0>c?0:255<c?255:c,d=0>d?0:255<d?255:d;if(0===d)return[c,c,c];a=0;127.5>=c?a=c*(255+d)/255:(a=c*d/255,a=c+d-a);var e=2*c-a;if(0>b||360<=b)b=(b%360+360)%360;var l=b+120;360<=l&&(l-=360);c=60>l?e+(a-e)*l/60:180>l?a:240>l?e+(a-e)*(240-l)/60:e;l=b;d=60>l?e+(a-e)*l/60:180>l?a:240>l?e+(a-e)*(240-l)/60:e;l=b-120;0>l&&(l+=360);b=60>l?e+(a-e)*l/60:180>l?a:240>l?e+(a-e)*(240-l)/60:e;return[0>c?0:255<c?255:c,0>d?0:255<d?255:d,0>b?0:255<b?255:b]},
c=function(a){function l(a){var b;return 255*(0>(b=parseFloat(a))?0:100<b?100:b)/100}function f(a){var b;return 255*(0>(b=parseFloat(a))?0:1<b?1:b)}function g(a){var b;return 0>(b=parseInt(a,10))?0:255<b?255:b}function h(a){a=parseFloat(k[1]);if(0>a||360<=a)a=(a%360+360)%360;return a}var k=null;if(!a)return null;var m;if(null!==(k=/^#([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})$/.exec(a)))return[parseInt(k[1],16),parseInt(k[2],16),parseInt(k[3],16),255];if(null!==(k=/^rgb\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*\)$/.exec(a)))return[l(k[1]),
l(k[2]),l(k[3]),255];if(null!==(k=/^rgb\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*\)$/.exec(a)))return[g(k[1]),g(k[2]),g(k[3]),255];if(null!==(k=/^rgba\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return[l(k[1]),l(k[2]),l(k[3]),f(k[4])];if(null!==(k=/^rgba\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return[g(k[1]),g(k[2]),g(k[3]),f(k[4])];if(null!==
(k=/^#([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})$/.exec(a))){var n=parseInt(k[1],16);a=parseInt(k[2],16);m=parseInt(k[3],16);return[n+(n<<4),a+(a<<4),m+(m<<4),255]}if(null!==(k=/^hsl\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*\)$/.exec(a)))return a=b([h(k[1]),l(k[3]),l(k[2])]),[a[0],a[1],a[2],255];if(null!==(k=/^hsla\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return a=
b([h(k[1]),l(k[3]),l(k[2])]),[a[0],a[1],a[2],f(k[4])];e();a=a.toLowerCase();0<=a.indexOf("grey")&&(a=a.replace("grey","gray"));m=d[a];return"string"===typeof m?c(m):"transparent"===a?[0,0,0,0]:null};a.toGLColor=function(a,b,d,e){return null==a?[0,0,0,0]:"string"==typeof a?(a=c(a)||[0,0,0,0],b=1/255,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,a):"number"==typeof a&&"number"==typeof b&&"number"==typeof d?[a,b,d,"number"!=typeof e?1:e]:a.constructor==Array?[a[0]||0,a[1]||0,a[2]||0,"number"!=typeof a[3]?1:a[3]]:
a||[0,0,0,0]};var d=null,e=function(){if(!d){var a="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
d={};for(var b=0;b<a.length;b+=2)d[a[b]]="#"+a[b+1]}}})(k);k._toContext=function(a){return a&&a.getContext?a.getContext():a};k._isPowerOfTwo=function(a){if(Math.floor(a)!=a||0>=a)return!1;for(;1<a&&0==(a&1);)a>>=1;return 1==a};a.MAX_LIGHTS=3;a._createLight=function(a,b,c,d,e){null!=c&&(c=k.toGLColor(c));null!=d&&(d=k.toGLColor(d));b=b?[b[0],b[1],b[2],e?0:1]:e?[0,0,1,0]:[0,0,0,1];c=c||(0==a?[1,1,1]:[0,0,0]);a=d||(0==a?[1,1,1]:[0,0,0]);d=new f;d.ambient=[0,0,0,1];d.position=b;d.diffuse=c;d.specular=
a;return d};a.prototype.setDirectionalLight=function(b,c,d,e){this.lights[b]=a._createLight(b,c,d,e,!0);return this};a.prototype.setPointLight=function(b,c,d,e){this.lights[b]=a._createLight(b,c,d,e,!1);return this};a.prototype.addDirectionalLight=function(b,c,d){this.lights.push(a._createLight(this.lights.length,b,c,d,!0));return this};a.prototype.addPointLight=function(b,c,d){this.lights.push(a._createLight(this.lights.length,b,c,d,!1));return this};b.prototype.copy=function(){return new b(this.ambient.slice(0,
this.ambient.length),this.diffuse.slice(0,this.diffuse.length),this.specular.slice(0,this.specular.length),this.shininess,this.emission.slice(0,this.emission.length))};b.fromColor=function(a,c,d,e){a=k.toGLColor(a,c,d,e);return new b(a,a)};var n=function(a){this.loadedTexture=this.image=null;this.name=a;this.height=this.width=0};n.loadTexture=function(a,b){if(b&&b[a])return Promise.resolve(b[a]);var c=new n(a);b&&(b[a]=c);return c.loadImage().then(function(a){return a},function(a){return Promise.reject(a.name)})};
n.prototype.loadImage=function(){if(null!==this.image)return Promise.resolve(this);var a=this,b=this.name;return new Promise(function(c,d){var e=new Image;e.onload=function(b){b=b.target;a.image=b;a.width=b.width;a.height=b.height;a.powerOfTwo=k._isPowerOfTwo(a.width)&&k._isPowerOfTwo(a.height);c(a)};e.onerror=function(a){d({name:name,error:a})};e.src=b})};n.prototype.dispose=function(){null==this.loadedTexture&&(this.loadedTexture.dispose(),this.loadedTexture=null)};c.prototype.getContext=function(){return this.context};
c.prototype.getFormat=function(){for(var a=0,b=0;b<this.subMeshes.length;b++)a|=this.subMeshes[b].format;return a};c.prototype.draw=function(a){for(var b=0;b<this.subMeshes.length;b++)this.subMeshes[b].draw(a)};c.prototype.dispose=function(){for(var a=0;a<this.subMeshes;a++)this.subMeshes[a].dispose()};c._vertexAttrib=function(a,b,c,d,e,f){null!==b&&(a.enableVertexAttribArray(b),a.vertexAttribPointer(b,c,d,!1,e,f))};d.prototype.dispose=function(){null!=this.verts&&this.context.deleteBuffer(this.verts);
null!=this.faces&&this.context.deleteBuffer(this.faces);this.faces=this.verts=null};d.prototype.draw=function(a){var b=a.getContext();if(null==this.verts||null==this.faces)throw Error("mesh buffer disposed");if(b!=this.context)throw Error("can't bind mesh: context mismatch");b.bindBuffer(b.ARRAY_BUFFER,this.verts);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.faces);var d=this.format,e=Mesh.getStride(d),f=[],g=a.get("position");f.push(g);c._vertexAttrib(b,g,3,b.FLOAT,4*e,0);var h=Mesh.normalOffset(d);
0<=h&&(g=a.get("normal"),f.push(g),c._vertexAttrib(b,g,3,b.FLOAT,4*e,4*h));h=Mesh.colorOffset(d);0<=h?(a.setUniforms({useColorAttr:1}),g=a.get("colorAttr"),f.push(g),c._vertexAttrib(b,g,3,b.FLOAT,4*e,4*h)):a.setUniforms({useColorAttr:0});h=Mesh.texCoordOffset(d);0<=h&&(g=a.get("uv"),f.push(g),c._vertexAttrib(b,g,2,b.FLOAT,4*e,4*h));b=a.getContext();if(null==this.verts||null==this.faces)throw Error("mesh buffer disposed");if(b!=this.context)throw Error("can't bind mesh: context mismatch");b.drawElements(0!=
(this.format&Mesh.LINES_BIT)?b.LINES:b.TRIANGLES,this.facesLength,this.type,0);for(a=0;a<f.length;a++)b.disableVertexAttribArray(f[a])};e.prototype.getMaterial=function(){var a=this;return{bind:function(b){var c={};c.textureSize=[a.width,a.height];b.setUniforms(c);b=b.getContext();b.activeTexture(b.TEXTURE0);b.bindTexture(b.TEXTURE_2D,a.colorTexture)}}};e.prototype.getContext=function(){return this.context};e.prototype.bind=function(a){if(a.getContext()!=this.context)throw Error("can't bind buffer: context mismatch");
this.context.bindFramebuffer(this.context.FRAMEBUFFER,this.buffer)};e.prototype.unbind=function(){this.context.bindFramebuffer(this.context.FRAMEBUFFER,null)};e.prototype.dispose=function(){null!=this.buffer&&this.context.deleteFramebuffer(this.buffer);null!=this.depthbuffer&&this.context.deleteRenderbuffer(this.depthbuffer);null!=this.colorTexture&&this.context.deleteTexture(this.colorTexture);this.colorTexture=this.depthbuffer=this.buffer=null};g.prototype.getContext=function(){return this.context};
g.prototype.getClearColor=function(){return this.clearColor.slice(0,4)};g.prototype._getDefines=function(){var a="";this.lightingEnabled&&(a+="#define SHADING\n");this.specularEnabled&&(a+="#define SPECULAR\n");return a};g.prototype._initProgramData=function(){this.program.setUniforms({sampler:0});(new LightsBinder(this.lightSource)).bind(this.program);this._updateMatrix()};g.prototype.useProgram=function(a){if(!a)throw Error("invalid program");a.use();this.program=a;this._initProgramData();return this};
g.prototype.disableLighting=function(){this.lightingEnabled=!1;var a=new ShaderProgram(this.context,this._getDefines()+ShaderProgram.getDefaultVertex(),this._getDefines()+ShaderProgram.getDefaultFragment());return this.useProgram(a)};g.prototype.setDimensions=function(a,b){if(0>a||0>b)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(b);this.context.canvas.width=this.width+"";this.context.canvas.height=this.height+"";this.context.viewport(0,0,this.width,this.height);
"undefined"!=this.fbo&&this.fbo&&(this.fbo.dispose(),this.fbo=this.createBuffer())};g.prototype.getWidth=function(){return this.width};g.prototype.getHeight=function(){return this.height};g.prototype.getAspect=function(){return this.getWidth()/this.getHeight()};g.prototype.createBuffer=function(){return new e(this.context,this.getWidth(),this.getHeight())};g.prototype.setPerspective=function(a,b,c,d){return this.setProjectionMatrix(GLMath.mat4perspective(a,b,c,d))};g.prototype.setFrustum=function(a,
b,c,d,e,f){return this.setProjectionMatrix(GLMath.mat4frustum(a,b,d,c,e,f))};g.prototype.setOrtho=function(a,b,c,d,e,f){return this.setProjectionMatrix(GLMath.mat4ortho(a,b,c,d,e,f))};g.prototype.setOrtho2D=function(a,b,c,d){return this.setProjectionMatrix(GLMath.mat4ortho(a,b,c,d,-1,1))};g.prototype._setClearColor=function(){this.context.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);return this};g.prototype.setClearColor=function(a,b,c,d){this.clearColor=
k.toGLColor(a,b,c,d);return this._setClearColor()};g.prototype.loadTexture=function(a){return n.loadTexture(a,this.textureCache)};g.prototype.loadAndMapTexture=function(a){return n.loadAndMapTexture(a,this.context,this.textureCache)};g.prototype.loadAndMapTextures=function(a,b,c){for(var d=[],e=this.context,f=0;f<a.length;f++){var g=this.loadAndMapTexture(a[f]).then(function(a){a.loadedTexture=new LoadedTexture(a,e)});d.push(g)}return k.getPromiseResults(d,b,c)};g.prototype._setIdentityMatrices=function(){this._projectionMatrix=
GLMath.mat4identity();this._viewMatrix=GLMath.mat4identity();this._updateMatrix()};g.prototype._updateMatrix=function(){this.program.setUniforms({view:this._viewMatrix,projection:this._projectionMatrix,viewMatrix:this._viewMatrix,projectionMatrix:this._projectionMatrix})};g.prototype.setProjectionMatrix=function(a){this._projectionMatrix=GLMath.mat4copy(a);this._updateMatrix();return this};g.prototype.setViewMatrix=function(a){this._viewMatrix=GLMath.mat4copy(a);this._updateMatrix();return this};
g.prototype.setLookAt=function(a,b,c){c=c||[0,1,0];b=b||[0,0,0];this._viewMatrix=GLMath.mat4lookat(a,b,c);this._updateMatrix();return this};g.prototype.addShape=function(a){this.shapes.push(a);return this};g.prototype.makeShape=function(a){a=new c(a,this.context);return new h(a)};g.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]==a&&(this.shapes.splice(b,1),b--);return this};g.prototype.setDirectionalLight=function(a,b,c,d){this.lightSource.setDirectionalLight(a,
b,c,d);(new LightsBinder(this.lightSource)).bind(this.program);return this};g.prototype.setAmbient=function(a,b,c,d){this.lightSource.ambient=k.toGLColor(a,b,c,d);this.lightSource.ambient=this.lightSource.ambient.slice(0,4);(new LightsBinder(this.lightSource)).bind(this.program);return this};g.prototype.setPointLight=function(a,b,c,d){this.lightSource.setPointLight(a,b,c,d);(new LightsBinder(this.lightSource)).bind(this.program);return this};g.prototype._setupMatrices=function(a,b){var c={},d=a.getMatrix(),
e=GLMath.mat4multiply(this._viewMatrix,d),f=GLMath.mat4inverseTranspose3(e);c.world=d;c.modelMatrix=d;c.modelViewMatrix=e;c.worldViewInvTrans3=f;c.normalMatrix=f;b.setUniforms(c)};g.prototype.render=function(){if("undefined"!=typeof this.fboFilter&&this.fboFilter){this.fbo.bind(this.program);this._renderInner();this.fbo.unbind();var a=this.program,b=this._projectionMatrix.slice(0,16),c=this._viewMatrix.slice(0,16);this.useProgram(this.fboFilter);this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT);
this._setIdentityMatrices();this._renderShape(this.fboQuad,this.fboFilter);this.setProjectionMatrix(b);this.setViewMatrix(c);this.useProgram(a)}else this._renderInner();this.context.flush();return this};g.prototype._renderShape=function(a,b){this._setupMatrices(a,b);Binders.getMaterialBinder(a.material).bind(b);a.bufferedMesh.draw(b)};g.prototype.useFilter=function(a){null==a?this.fboFilter=null:(this.fboFilter="string"==typeof a?ShaderProgram.makeEffect(this.context,a):a,"undefined"!=typeof this.fbo&&
this.fbo||(this.fbo=this.createBuffer()),"undefined"!=typeof this.fboQuad&&this.fboQuad||(this.getWidth(),this.getHeight(),a=new Mesh([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0],[0,1,2,2,1,3],Mesh.TEXCOORDS_BIT),this.fboQuad=this.makeShape(a).setMaterial(this.fbo.getMaterial())));return this};g.prototype._renderInner=function(){this._updateMatrix();this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT);for(var a=0;a<this.shapes.length;a++)this._renderShape(this.shapes[a],
this.program);return this};m.prototype.setScale=function(a,b,c){for(var d=0;d<this.shapes.length;d++)this.shapes[d].setScale(a,b,c)};m.prototype.render=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].render(a)};m.prototype.loadMesh=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].loadMesh(a);return this};m.prototype.add=function(a){this.shapes.push(a)};m.prototype.setMaterial=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setMaterial(a)};h.prototype.setMatrix=
function(a){this._matrixDirty=!1;this.matrix=a.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=GLMath.quatFromMat4(this.matrix);this.rotation=GLMath.quatNormInPlace(this.rotation);this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];return this};h.prototype.setColor=function(a,c,d,e){this.material=b.fromColor(a,c,d,e);return this};h.prototype.setTexture=function(a){this.material=new n(a);return this};h.prototype.setMaterial=function(a){this.material=
a;return this};h.prototype.setScale=function(a,b,c){this.scale=null!=a&&null==b&&null==c?a.constructor==Array?a.slice(0,3):[a,a,a]:[a,b,c];this._matrixDirty=!0;return this};h.prototype.setPosition=function(a,b,c){this.position=null!=a&&null==b&&null==c?a.constructor==Array?a.slice(0,3):[a,a,a]:[a,b,c];this._matrixDirty=!0;return this};h.prototype.setQuaternion=function(a){this.rotation=a.slice(0,4);GLMath.quatNormInPlace(this.rotation);this._matrixDirty=!0;return this};h.prototype.setRotation=function(a,
b,c,d){return this.setQuaternion(GLMath.quatFromAxisAngle(a,b,c,d))};h.prototype.multQuaternion=function(a){this.rotation=GLMath.quatMultiply(this.rotation,a);GLMath.quatNormInPlace(this.rotation);this._matrixDirty=!0;return this};h.prototype.multRotation=function(a,b,c,d){return this.multQuaternion(GLMath.quatFromAxisAngle(a,b,c,d))};h.prototype.getMatrix=function(){this._matrixDirty&&(this._matrixDirty=!1,this.matrix=GLMath.mat4translated(this.position[0],this.position[1],this.position[2]),GLMath.quatIsIdentity(this.rotation)||
(this.matrix=GLMath.mat4multiply(this.matrix,GLMath.quatToMat4(this.rotation))),GLMath.mat4scaleInPlace(this.matrix,this.scale));return this.matrix.slice(0,16)};p.BufferedMesh=c;p.Lights=a;p.FrameBuffer=e;p.LightSource=f;p.Texture=n;p.MaterialShade=b;p.MultiShape=m;p.Shape=h;p.Scene3D=g;p.GLUtil=k}});
(function(p){var f=function(a){a=a||"#ff0000";this.height=this.width=1E3;var b=$("<canvas>").attr("width",this.width+"").attr("height",this.height+"").css({width:"100%",height:"100%",left:"0px",zIndex:-1,top:"0px",position:"fixed"});$("body").append(b);this.use3d=!0;this.count=0;b=b.get(0);this.context=GLUtil.get3DOr2DContext(b);this.use3d=GLUtil.is3DContext(this.context);this.shapes=[];this.setColor(a)};f.varyColor=function(a){var b=a[0]-7.5+f.rand(15);360<=b?b=360-b:0>b&&(b=360+b);var c=a[1],c=
15>=c?f.rand(30):240<c?240+f.rand(30):c-15+f.rand(30),d=a=a[2],d=15>=d?f.rand(30):240<d?240+f.rand(30):d+f.rand(30);0<a&&0<c&&255>c&&(25>=c&&(c=25),242<=c&&(c=242));return[b,c,d]};f.rand=function(a){return Math.random()*a|0};f.rgb2hls=function(a){var b=a[0],c=a[1];a=a[2];var d=b;c>d&&(d=c);a>d&&(d=a);var e=b;c<e&&(e=c);a<e&&(e=a);var f=d+e,m=f/2;if(d===e)return[0,0>m?0:255<m?255:m,0];var e=d-e,f=255*e/(127.5>=m?f:510-f),h=0,h=e/2,h=b===d?(60*(d-a)+h)/e-(60*(d-c)+h)/e:a===d?240+(60*(d-c)+h)/e-(60*
(d-b)+h)/e:120+(60*(d-b)+h)/e-(60*(d-a)+h)/e;if(0>h||360<=h)h=(h%360+360)%360;return[h,0>m?0:255<m?255:m,0>f?0:255<f?255:f]};f.hls2rgb=function(a){var b=1*a[0],c=1*a[1],d=1*a[2],c=0>c?0:255<c?255:c,d=0>d?0:255<d?255:d;if(0===d)return[c,c,c];a=0;127.5>=c?a=c*(255+d)/255:(a=c*d/255,a=c+d-a);var e=2*c-a;if(0>b||360<=b)b=(b%360+360)%360;var f=b+120;360<=f&&(f-=360);c=60>f?e+(a-e)*f/60:180>f?a:240>f?e+(a-e)*(240-f)/60:e;f=b;d=60>f?e+(a-e)*f/60:180>f?a:240>f?e+(a-e)*(240-f)/60:e;f=b-120;0>f&&(f+=360);b=
60>f?e+(a-e)*f/60:180>f?a:240>f?e+(a-e)*(240-f)/60:e;return[0>c?0:255<c?255:c,0>d?0:255<d?255:d,0>b?0:255<b?255:b]};f.component2hex=function(a){a="0"+(a|0).toString(16);return a.substring(a.length-2,a.length)};f.hls2hex=function(a){a=f.hls2rgb(a);return"#"+f.component2hex(a[0])+f.component2hex(a[1])+f.component2hex(a[2])};f.prototype.start=function(){GLUtil.renderLoop(this.animate.bind(this))};f.prototype.setColor=function(a){a=GLUtil.colorToRgba(a);if(!a)throw Error("invalid color parameter");this.color=
[a[0],a[1],a[2]];this.hls=this.constructor.rgb2hls(a);this.drawBack()};f.prototype.drawBack=function(){document.body.style.backgroundColor=this.constructor.hls2hex(this.hls);if(this.use3d){var a=this.constructor.hls2rgb(this.hls);this.cubeMesh=Meshes.createBox(2,2,2);this.sphereMesh=Meshes.createSphere();this.torusMesh=Meshes.createTorus(.5,1);this.cylinderMesh=Meshes.createClosedCylinder(1,1,2);this.scene=(new Scene3D(this.context)).setDirectionalLight(0,[0,0,-1]).setClearColor(a[0]/255,a[1]/255,
a[2]/255,1)}else this.context.fillStyle=this.constructor.hls2hex(this.hls),this.context.fillRect(0,0,this.width,this.height)};f.prototype.animate=function(){this.count++;4<=this.count&&(this.count=0,this.drawOne());this.use3d&&this.scene.render()};f.prototype.drawOne=function(){var a=this.constructor.varyColor(this.hls);if(this.use3d){300<this.shapes.length&&this.scene.shapes.shift();var b=this.constructor.rand(2E3)/1E3-1,c=this.constructor.rand(2E3)/1E3-1,d=this.constructor.rand(60)/60,e=[this.cubeMesh,
this.sphereMesh,this.torusMesh,this.cylinderMesh][this.constructor.rand(4)],f=(16+this.constructor.rand(100))/1E3,a=this.constructor.hls2rgb(a);a[0]/=255;a[1]/=255;a[2]/=255;this.constructor.rand(160);var m=GLMath.quatFromEuler(this.constructor.rand(360),this.constructor.rand(360),this.constructor.rand(360)),b=scene.makeShape(e).setScale(f,f,f).setQuaternion(m).setPosition(b,c,d).setColor(a);this.scene.addShape(b)}else b=[this.constructor.rand(this.width+30)-30,this.constructor.rand(this.height+30)-
30,32+this.constructor.rand(200),32+this.constructor.rand(200)],this.context.fillStyle=this.constructor.hls2hex(a),this.context.fillRect(b[0],b[1],b[2],b[3])};f.colorBackground=function(a){$(document).ready(function(){(new f(a)).start()})};p.CanvasBackground=f})(this);
